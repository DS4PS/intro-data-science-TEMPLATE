<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Reading---Merging-Data.knit</title>

<script src="Reading---Merging-Data_files/header-attrs-2.14/header-attrs.js"></script>
<script src="Reading---Merging-Data_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="Reading---Merging-Data_files/bootstrap-3.3.5/css/readable.min.css" rel="stylesheet" />
<script src="Reading---Merging-Data_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="Reading---Merging-Data_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="Reading---Merging-Data_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="Reading---Merging-Data_files/navigation-1.1/tabsets.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  background-color: #f8f8f8; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="textbook.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div id="header">




</div>

<div id="TOC">
<ul>
<li><a href="#merging-data"><span class="toc-section-number">1</span>
Merging Data</a></li>
<li><a href="#overview-of-joins"><span
class="toc-section-number">2</span> Overview of Joins</a></li>
</ul>
</div>

<div id="merging-data" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Merging Data</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( dplyr )</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>( pander )</span></code></pre></div>
<p><br></p>
<p>This chapter demonstrates the process of joining two datasets through
a <strong>merge()</strong> function. This is one of the most common and
most important processes in data science, because it allows you to
combine multiple datasets to link observations that pertain to the same
individuals / cases. The deepest insights often come from bringing data
together in this way.</p>
<p><br><br></p>
</div>
<div id="overview-of-joins" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Overview of Joins</h1>
<p><br></p>
<div id="inner-outer-left-and-right" class="section level2"
number="2.1">
<h2><span class="header-section-number">2.1</span> Inner, Outer, Left
and Right</h2>
<p>There are two things to remember when conducting joins. The first is
that when you merge two datasets it is rare for them both to contain the
exact same observations. As a result, you need to make decisions about
which data to keep and which data to drop post-merge. There are four
options:</p>
<ul>
<li>Keep everything: “Outer Join”</li>
<li>Keep only observations in both datasets: “Inner Join”</li>
<li>Keep all observations from dat1: “Left Join”</li>
<li>Keep all observations from dat2: “Right Join”</li>
</ul>
<p><br></p>
<p><img src="figures/shared_observations.png" width="40%" style="display: block; margin: auto;" /></p>
<p><br></p>
<p>These options are specified through the <em>all=</em>,
<em>all.x=</em>, and <em>all.y=</em> arguments in the
<strong>merge()</strong> function, where the arguments all.x stands for
observations in dat1, and all.y stands for observations in dat2 in this
example.</p>
<p><img src="figures/outer_join.png" width="80%" style="display: block; margin: auto;" /></p>
<p><br></p>
<p><img src="figures/inner_join.png" width="80%" style="display: block; margin: auto;" /></p>
<p><br></p>
<p><img src="figures/left_join.png" width="80%" style="display: block; margin: auto;" /></p>
<p><br></p>
<p><img src="figures/right_join.png" width="80%" style="display: block; margin: auto;" /></p>
<p><br><br></p>
</div>
<div id="compound-ids" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Compound IDs</h2>
<p>It is often the case where a single ID does not uniquely specify
observations needed to join data. For example, if you are looking at the
relationship between employee eye color and their height, these are both
variables that can only have one value per employee, so the employee ID
would be sufficient to merge the eye color and height datasets.</p>
<p>If we want to look at the relationship between employee sick days in
a given year and their performance, we now might have multiple years of
data for each employee. To merge these two datasets we need to use both
ID and YEAR. This is an example of a compound ID - two or more variables
are needed to create a unique key for the join.</p>
<p><img src="figures/compound_ids.png" width="60%" style="display: block; margin: auto;" /></p>
<p>Consider an example where sales representatives get a bonus if they
sell over $100,000 in subscriptions each year. We have one database
generated by the sales department, and another generated by HR. We want
to merge them to ensure bonuses have been properly issued. The data
tables are structured as follows:</p>
<table style="width:29%;">
<colgroup>
<col width="6%" />
<col width="9%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">year</th>
<th align="center">sales</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">A</td>
<td align="center">2001</td>
<td align="center">54000</td>
</tr>
<tr class="even">
<td align="center">A</td>
<td align="center">2002</td>
<td align="center">119000</td>
</tr>
<tr class="odd">
<td align="center">B</td>
<td align="center">2001</td>
<td align="center">141000</td>
</tr>
<tr class="even">
<td align="center">B</td>
<td align="center">2002</td>
<td align="center">102000</td>
</tr>
<tr class="odd">
<td align="center">C</td>
<td align="center">2001</td>
<td align="center">66000</td>
</tr>
<tr class="even">
<td align="center">C</td>
<td align="center">2002</td>
<td align="center">68000</td>
</tr>
</tbody>
</table>
<table style="width:28%;">
<colgroup>
<col width="6%" />
<col width="9%" />
<col width="11%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">year</th>
<th align="center">bonus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">A</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">A</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">B</td>
<td align="center">2001</td>
<td align="center">TRUE</td>
</tr>
<tr class="even">
<td align="center">B</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">C</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">C</td>
<td align="center">2002</td>
<td align="center">FALSE</td>
</tr>
</tbody>
</table>
<p>The RIGHT way to merge these tables is to specify the set of IDs that
allow you to identify unique observations. The employee ID is not
sufficient in this case because there are separate observations for each
year. As a result:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>( dat1, dat2, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&quot;id&quot;</span>,<span class="st">&quot;year&quot;</span>) )         <span class="sc">%&gt;%</span> <span class="fu">pander</span>()</span></code></pre></div>
<table style="width:42%;">
<colgroup>
<col width="6%" />
<col width="9%" />
<col width="12%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">year</th>
<th align="center">sales</th>
<th align="center">bonus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">A</td>
<td align="center">2001</td>
<td align="center">54000</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">A</td>
<td align="center">2002</td>
<td align="center">119000</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">B</td>
<td align="center">2001</td>
<td align="center">141000</td>
<td align="center">TRUE</td>
</tr>
<tr class="even">
<td align="center">B</td>
<td align="center">2002</td>
<td align="center">102000</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">C</td>
<td align="center">2001</td>
<td align="center">66000</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">C</td>
<td align="center">2002</td>
<td align="center">68000</td>
<td align="center">FALSE</td>
</tr>
</tbody>
</table>
<p>The WRONG way to merge these two datasets is to use only the employee
ID. In this case, since the rows are now no longer unique, the only
choice the <strong>merge()</strong> function has is to join EVERY
instance on the right to each instance on the left. It has the effect of
blowing up the size of the database (notice we have increased from 6 to
12 rows), as well as duplicating fields and incorrectly aligning
data.</p>
<p>Row number 2, for example, reports that employee A received a bonus
on $54,000 in sales.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>( dat1, dat2, <span class="at">by=</span><span class="st">&quot;id&quot;</span> )         <span class="sc">%&gt;%</span> <span class="fu">pander</span>()</span></code></pre></div>
<table style="width:57%;">
<colgroup>
<col width="6%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
<col width="12%" />
</colgroup>
<thead>
<tr class="header">
<th align="center">id</th>
<th align="center">year.x</th>
<th align="center">sales</th>
<th align="center">year.y</th>
<th align="center">bonus</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="center">A</td>
<td align="center">2001</td>
<td align="center">54000</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">A</td>
<td align="center">2001</td>
<td align="center">54000</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">A</td>
<td align="center">2002</td>
<td align="center">119000</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">A</td>
<td align="center">2002</td>
<td align="center">119000</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">B</td>
<td align="center">2001</td>
<td align="center">141000</td>
<td align="center">2001</td>
<td align="center">TRUE</td>
</tr>
<tr class="even">
<td align="center">B</td>
<td align="center">2001</td>
<td align="center">141000</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">B</td>
<td align="center">2002</td>
<td align="center">102000</td>
<td align="center">2001</td>
<td align="center">TRUE</td>
</tr>
<tr class="even">
<td align="center">B</td>
<td align="center">2002</td>
<td align="center">102000</td>
<td align="center">2002</td>
<td align="center">TRUE</td>
</tr>
<tr class="odd">
<td align="center">C</td>
<td align="center">2001</td>
<td align="center">66000</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">C</td>
<td align="center">2001</td>
<td align="center">66000</td>
<td align="center">2002</td>
<td align="center">FALSE</td>
</tr>
<tr class="odd">
<td align="center">C</td>
<td align="center">2002</td>
<td align="center">68000</td>
<td align="center">2001</td>
<td align="center">FALSE</td>
</tr>
<tr class="even">
<td align="center">C</td>
<td align="center">2002</td>
<td align="center">68000</td>
<td align="center">2002</td>
<td align="center">FALSE</td>
</tr>
</tbody>
</table>
<p>The solution is to ensure you are using the combination of keys that
ensures each observation is correctly specified.</p>
<p><br><br></p>
</div>
<div id="merge-keys" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> Merge Keys</h2>
<p>Your “keys” are the shared IDs across your datasets used for the
join. You can check for shared variable names by looking at the
intersection of names in both:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">intersect</span>( <span class="fu">names</span>(dat1), <span class="fu">names</span>(dat2) )</span></code></pre></div>
<pre><code>## [1] &quot;id&quot;   &quot;year&quot;</code></pre>
<p>This works when the datasets were generated from a common system that
uses standardized and identical ID names. In other cases, the same key
may be spelled differently (‘year’ vs. ‘YEAR’) or have completely
different names.</p>
<p>The check above at least allows you to catch instances where variable
names would be repeated, and thus duplicated in the merged file. When
this happens, like the ‘year’ variable in the example above, the merge
operation will add an ‘x’ and ‘y’ to the end of the variable names to
specify which dataset they originated from (‘year.x’ and ‘year.y’ in the
example above).</p>
<p>In instances where variable names differ, you can specify the names
directly using “by.x=” and “by.y=”:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>( dat1, dat2, <span class="at">by.x=</span><span class="st">&quot;fips&quot;</span>, <span class="at">by.y=</span><span class="st">&quot;FIPS&quot;</span> ) </span></code></pre></div>
<p><br><br></p>
</div>
<div id="in-summary" class="section level2" number="2.4">
<h2><span class="header-section-number">2.4</span> In Summary</h2>
<p>You will be using the <strong>merge()</strong> function in this lab
to join datasets. You need to specify two arguments in each merge
call.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">merge</span>( dat1, dat2, <span class="at">by=</span><span class="st">&quot;&quot;</span>, <span class="at">all=</span><span class="st">&quot;&quot;</span> )</span></code></pre></div>
<p>Your IDs used to join dataset:</p>
<ul>
<li>Use “by=” when variable names are identical</li>
<li>Use “by.x=” and “by.y=” when the variable names are spelled
differently</li>
<li>Remember the c() when you have a compound key:
by=c(“FIPS”,“YEAR”)</li>
</ul>
<p>Specify an outer, inner, left, or right join:</p>
<ul>
<li>all=TRUE creates an outer join</li>
<li>all=FALSE creates an inner join</li>
<li>all.x=TRUE creates a left join</li>
<li>all.y=TRUE creates a right join</li>
</ul>
<p><br><br></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
